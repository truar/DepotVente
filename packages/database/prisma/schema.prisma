// Prisma Schema for PostgreSQL
// With UUID for RxDB sync

generator client {
  provider      = "prisma-client-js"
  output        = "../generated/client"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

generator zod {
  provider         = "zod-prisma-types"
  output           = "../../types/src/generated"
  createInputTypes = true
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Events - Ex: Ski Sale 2025
model Event {
  id          String    @id @default(uuid()) @db.Uuid
  name        String // Ex: "Ski Sale"
  year        Int // Ex: 2025
  description String?
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  isActive    Boolean   @default(true) @map("is_active")

  // Relations
  sales        Sale[]
  deposits     Deposit[]
  workstations Workstation[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  articles  Article[]

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("events")
}

// Workstations - Cash register stations
model Workstation {
  id              String @id @default(uuid()) @db.Uuid
  eventId         String @map("event_id") @db.Uuid
  name            String // Ex: "Station 1"
  increment_start Int // Ex: 1000

  // Relations
  event    Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  sales    Sale[]
  deposits Deposit[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@unique([eventId, name])
  @@index([updatedAt])
  @@index([deletedAt])
  @@map("workstations")
}

// Users - Admin
model User {
  id       String @id @default(uuid()) @db.Uuid
  email    String
  password String

  // Relations
  sales  Sale[]
  depots Deposit[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("users")
}

// Contacts - Déposants et Acheteurs
model Contact {
  id          String  @id @default(uuid()) @db.Uuid
  lastName    String  @map("last_name")
  firstName   String  @map("first_name")
  phoneNumber String  @map("phone_number")
  city        String?
  postalCode  String? @map("postal_code")

  // Relations
  sales  Sale[]
  depots Deposit[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("contacts")
}

// Deposit
model Deposit {
  id                 String             @id @default(uuid()) @db.Uuid
  eventId            String             @map("event_id") @db.Uuid
  sellerId           String             @map("seller_id") @db.Uuid
  workstationId      String             @map("workstation_id") @db.Uuid
  contributionStatus ContributionStatus @default(A_PAYER) @map("contribution_status")
  depositIndex       Int                @map("depot_index")

  // Relations
  event       Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  seller      Contact     @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  workstation Workstation @relation(fields: [workstationId], references: [id])
  articles    Article[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  user      User?     @relation(fields: [userId], references: [id])
  userId    String?   @db.Uuid

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("deposits")
}

enum ContributionStatus {
  PAYER
  A_PAYER
  GRATUIT
}

// Sales - Ventes
model Sale {
  id            String @id @default(uuid()) @db.Uuid
  eventId       String @map("event_id") @db.Uuid
  buyerId       String @map("buyer_id") @db.Uuid
  workstationId String @map("workstation_id") @db.Uuid

  // Montants des différents moyens de paiement
  cardAmount  Decimal @default(0) @map("card_amount") @db.Decimal(10, 2)
  cashAmount  Decimal @default(0) @map("cash_amount") @db.Decimal(10, 2)
  checkAmount Decimal @default(0) @map("check_amount") @db.Decimal(10, 2)

  // Montant total de la vente (somme des articles vendus)
  totalAmount Decimal @default(0) @map("total_amount") @db.Decimal(10, 2)
  postalCode  String? @map("postal_code") // Code postal du client

  // Relations
  event       Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  buyer       Contact     @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  workstation Workstation @relation(fields: [workstationId], references: [id])
  articles    Article[]

  saleAt    DateTime  @default(now()) @map("sale_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  user      User?     @relation(fields: [userId], references: [id])
  userId    String?   @db.Uuid

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("sales")
}

// Articles
model Article {
  id String @id @default(uuid()) @db.Uuid

  // Informations article
  price        Decimal? @db.Decimal(10, 2)
  category     String
  discipline   String
  brand        String
  model        String
  size         String
  color        String
  code         String   @unique // Code-barres
  year         Int
  depositIndex Int
  articleIndex String

  eventId   String? @map("event_id") @db.Uuid
  // Un article appartient forcément à un dépot
  depositId String? @map("deposit_id") @db.Uuid
  // Un article vendu appartient forcément à une vente
  saleId    String? @map("sale_id") @db.Uuid

  event   Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)
  deposit Deposit? @relation(fields: [depositId], references: [id], onDelete: SetNull)
  sale    Sale?    @relation(fields: [saleId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([code])
  @@index([eventId])
  @@index([depositId])
  @@index([saleId])
  @@index([updatedAt])
  @@index([deletedAt])
  @@map("articles")
}

// Note: Les triggers PostgreSQL doivent être créés via une migration SQL
// Voir le fichier de migration pour les détails des triggers:
// - notify_stats_changed() : notifie sur le canal 'stats_changed'
// - notify_sales_changed() : notifie sur le canal 'sales_changed'
