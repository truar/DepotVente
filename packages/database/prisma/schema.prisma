// Prisma Schema for PostgreSQL
// With UUID for RxDB sync

generator client {
  provider      = "prisma-client-js"
  output        = "../generated/client"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

generator zod {
  provider         = "zod-prisma-types"
  output           = "../../types/src/generated"
  createInputTypes = true
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  BENEVOLE
}

// Users - ADMIN Or BENEVOLE
model User {
  id       String   @id @default(uuid()) @db.Uuid
  email    String
  password String
  role     UserRole @default(BENEVOLE)

  // Relations
  sales  Sale[]
  depots Deposit[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("users")
}

// Contacts - Déposants et Acheteurs
model Contact {
  id          String  @id @default(uuid()) @db.Uuid
  lastName    String  @map("last_name")
  firstName   String  @map("first_name")
  phoneNumber String  @map("phone_number")
  city        String?
  postalCode  String? @map("postal_code")

  // Relations
  sales  Sale[]
  depots Deposit[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("contacts")
}

// Deposit
model Deposit {
  id                 String             @id @default(uuid()) @db.Uuid
  sellerId           String             @map("seller_id") @db.Uuid
  contributionStatus ContributionStatus @default(A_PAYER) @map("contribution_status")
  contributionAmount Decimal            @default(2) @map("contribution_amount") @db.Decimal(3, 2)
  depositIndex       Int                @map("depot_index")
  incrementStart     Int                @map("increment_start")
  dropWorkstationId  Int                @map("deposit_workstation_id")
  type               DepositType        @default(PARTICULIER)

  collectWorkstationId Int?      @map("collect_workstation_id")
  collectedAt          DateTime? @map("collected_at")
  paymentAmount        Decimal?  @map("payment_amount") @db.Decimal(6, 2)
  chequeNumber         String?   @map("cheque_number")
  signature            String?

  // Relations
  seller   Contact   @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  articles Article[]

  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  deletedAt   DateTime?    @map("deleted_at")
  user        User?        @relation(fields: [userId], references: [id])
  userId      String?      @db.Uuid
  predeposits Predeposit[]

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("deposits")
}

enum ContributionStatus {
  PAYEE
  A_PAYER
  GRATUIT
  PRO
}

enum DepositType {
  PRO
  PARTICULIER
}

enum ArticleStatus {
  RECEPTION_PENDING
  RECEPTION_OK
  REFUSED
}

// Sales - Ventes
model Sale {
  id      String @id @default(uuid()) @db.Uuid
  buyerId String @map("buyer_id") @db.Uuid

  saleIndex      Int @map("sale_index")
  incrementStart Int @default(1) @map("increment_start")

  // Montants des différents moyens de paiement
  cardAmount  Decimal @default(0) @map("card_amount") @db.Decimal(10, 2)
  cashAmount  Decimal @default(0) @map("cash_amount") @db.Decimal(10, 2)
  checkAmount Decimal @default(0) @map("check_amount") @db.Decimal(10, 2)

  // Relations
  buyer    Contact   @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  articles Article[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  user      User?     @relation(fields: [userId], references: [id])
  userId    String?   @db.Uuid

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("sales")
}

// Articles
model Article {
  id String @id @default(uuid()) @db.Uuid

  // Informations article
  price                Decimal?      @db.Decimal(10, 2)
  category             String
  discipline           String
  brand                String
  model                String
  size                 String
  color                String
  code                 String        @unique // Code-barres
  year                 Int
  depositIndex         Int           @map("deposit_index")
  identificationLetter String        @map("identification_letter")
  articleIndex         Int           @map("article_index")
  status               ArticleStatus @default(RECEPTION_PENDING)

  // Un article appartient forcément à un dépot
  depositId String? @map("deposit_id") @db.Uuid
  // Un article vendu appartient forcément à une vente
  saleId    String? @map("sale_id") @db.Uuid

  deposit Deposit? @relation(fields: [depositId], references: [id], onDelete: SetNull)
  sale    Sale?    @relation(fields: [saleId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([code])
  @@index([depositId])
  @@index([saleId])
  @@index([updatedAt])
  @@index([deletedAt])
  @@map("articles")
}

// Predeposit
model Predeposit {
  id                String @id @default(uuid()) @db.Uuid
  predepositIndex   Int    @map("predeposit_index")
  sellerLastName    String
  sellerFirstName   String
  sellerPhoneNumber String
  sellerCity        String

  // Relations
  articles PredepositArticle[]

  // Has a depositId if predeposit was transformed to a depositId
  depositId String?  @map("deposit_id") @db.Uuid
  deposit   Deposit? @relation(fields: [depositId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("predeposits")
}

// Predeposit-articles
model PredepositArticle {
  id String @id @default(uuid()) @db.Uuid

  // Informations article
  price                Decimal? @db.Decimal(10, 2)
  category             String
  discipline           String
  brand                String
  model                String
  size                 String
  color                String
  year                 Int
  identificationLetter String   @map("identification_letter")
  articleIndex         Int      @map("article_index")

  // Un predepositarticle appartient forcément à un predeposit
  predepositId String? @map("predeposit_id") @db.Uuid

  predeposit Predeposit? @relation(fields: [predepositId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([predepositId])
  @@index([updatedAt])
  @@index([deletedAt])
  @@map("predepositArticles")
}

// Note: Les triggers PostgreSQL doivent être créés via une migration SQL
// Voir le fichier de migration pour les détails des triggers:
// - notify_stats_changed() : notifie sur le canal 'stats_changed'
// - notify_sales_changed() : notifie sur le canal 'sales_changed'
