// Prisma Schema for PostgreSQL
// With UUID for RxDB sync

generator client {
  provider      = "prisma-client-js"
  output        = "../generated/client"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

generator zod {
  provider         = "zod-prisma-types"
  output           = "../../types/src/generated"
  createInputTypes = true
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  BENEVOLE
}

// Users - ADMIN Or BENEVOLE
model User {
  id       String   @id @default(uuid()) @db.Uuid
  email    String
  password String
  role     UserRole @default(BENEVOLE)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("users")
}

model CashRegisterControl {
  id                    String  @id @default(uuid()) @db.Uuid
  cashRegisterId        Int     @map("cash_register_id")
  type                  String
  initialAmount         Decimal @map("initial_amount") @db.Decimal(10, 2)
  theoreticalCashAmount Decimal @map("theoretical_cash_amount") @db.Decimal(7, 2)
  realCashAmount        Decimal @map("real_cash_amount") @db.Decimal(7, 2)
  difference            Decimal @map("difference") @db.Decimal(7, 2)
  totalAmount           Decimal @map("total_amount") @db.Decimal(7, 2)

  cash200 Int
  cash100 Int
  cash50  Int
  cash20  Int
  cash10  Int
  cash5   Int
  cash2   Int
  cash1   Int
  cash05  Int
  cash02  Int
  cash01  Int
  cash005 Int
  cash002 Int
  cash001 Int

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("cashRegisterControls")
}

// Contacts - Déposants et Acheteurs
model Contact {
  id          String  @id @default(uuid()) @db.Uuid
  lastName    String  @map("last_name")
  firstName   String  @map("first_name")
  phoneNumber String  @map("phone_number")
  city        String?
  postalCode  String? @map("postal_code")

  // Relations
  sales  Sale[]
  depots Deposit[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("contacts")
}

// Deposit
model Deposit {
  id                 String  @id @default(uuid()) @db.Uuid
  sellerId           String  @map("seller_id") @db.Uuid
  contributionStatus String  @default("A_PAYER") @map("contribution_status")
  contributionAmount Decimal @default(2) @map("contribution_amount") @db.Decimal(3, 2)
  depositIndex       Int     @map("depot_index")
  incrementStart     Int     @map("increment_start")
  dropWorkstationId  Int     @map("deposit_workstation_id")
  type               String  @default("PARTICULIER")

  returnedCalculationDate DateTime? @map("returned_calculation_date")
  soldAmount              Decimal?  @map("sold_amount") @db.Decimal(10, 2)
  clubAmount              Decimal?  @map("club_amount") @db.Decimal(10, 2)
  dueContributionAmount   Decimal?  @map("due_contribution_amount") @db.Decimal(10, 2)
  sellerAmount            Decimal?  @map("seller_amount") @db.Decimal(10, 2)

  collectWorkstationId Int?      @map("collect_workstation_id")
  collectedAt          DateTime? @map("collected_at")
  checkId              String?   @map("cheque_number")
  signatory            String?

  // Relations
  seller   Contact   @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  articles Article[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("deposits")
}

// Sales - Ventes
model Sale {
  id      String @id @default(uuid()) @db.Uuid
  buyerId String @map("buyer_id") @db.Uuid

  saleIndex      Int @map("sale_index")
  incrementStart Int @default(1) @map("increment_start")

  // Montants des différents moyens de paiement
  cardAmount       Decimal @default(0) @map("card_amount") @db.Decimal(10, 2)
  cashAmount       Decimal @default(0) @map("cash_amount") @db.Decimal(10, 2)
  checkAmount      Decimal @default(0) @map("check_amount") @db.Decimal(10, 2)
  refundCardAmount Decimal @default(0) @map("refund_card_amount") @db.Decimal(10, 2)
  refundCashAmount Decimal @default(0) @map("refund_cash_amount") @db.Decimal(10, 2)
  refundComment    String  @default("") @map("refund_comment")

  // Relations
  buyer    Contact   @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  articles Article[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("sales")
}

// Articles
model Article {
  id String @id @default(uuid()) @db.Uuid

  // Informations article
  price                Decimal? @db.Decimal(10, 2)
  category             String
  discipline           String
  brand                String
  model                String?
  size                 String?
  color                String
  code                 String   @unique // Code-barres
  year                 Int
  depositIndex         Int      @map("deposit_index")
  identificationLetter String   @map("identification_letter")
  articleIndex         Int      @map("article_index")
  status               String   @default("RECEPTION_PENDING")

  // Un article appartient forcément à un dépot
  depositId String  @map("deposit_id") @db.Uuid
  // Un article vendu appartient forcément à une vente
  saleId    String? @map("sale_id") @db.Uuid

  deposit Deposit @relation(fields: [depositId], references: [id], onDelete: SetNull)
  sale    Sale?   @relation(fields: [saleId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([code])
  @@index([depositId])
  @@index([saleId])
  @@index([updatedAt])
  @@index([deletedAt])
  @@map("articles")
}

// Predeposit
model Predeposit {
  id                String @id @default(uuid()) @db.Uuid
  predepositIndex   Int    @map("predeposit_index")
  sellerLastName    String
  sellerFirstName   String
  sellerPhoneNumber String
  sellerCity        String

  // Relations
  articles PredepositArticle[]

  // Has a depositId if predeposit was transformed to a depositId
  depositId String? @map("deposit_id") @db.Uuid

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("predeposits")
}

// Predeposit-articles
model PredepositArticle {
  id String @id @default(uuid()) @db.Uuid

  // Informations article
  price                Decimal? @db.Decimal(10, 2)
  category             String
  discipline           String
  brand                String
  model                String
  size                 String
  color                String
  year                 Int
  identificationLetter String   @map("identification_letter")
  articleIndex         Int      @map("article_index")

  // Un predepositarticle appartient forcément à un predeposit
  predepositId String? @map("predeposit_id") @db.Uuid

  predeposit Predeposit? @relation(fields: [predepositId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([predepositId])
  @@index([updatedAt])
  @@index([deletedAt])
  @@map("predepositArticles")
}

// Note: Les triggers PostgreSQL doivent être créés via une migration SQL
// Voir le fichier de migration pour les détails des triggers:
// - notify_stats_changed() : notifie sur le canal 'stats_changed'
// - notify_sales_changed() : notifie sur le canal 'sales_changed'
