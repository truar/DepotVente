// Prisma Schema for PostgreSQL
// With UUID for RxDB sync

generator client {
  provider      = "prisma-client-js"
  output        = "../generated/client"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

generator zod {
  provider         = "zod-prisma-types"
  output           = "../../types/src/generated"
  createInputTypes = true
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users - Admin
model User {
  id       String @id @default(uuid()) @db.Uuid
  email    String
  password String

  // Relations
  sales  Sale[]
  depots Deposit[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("users")
}

// Contacts - Déposants et Acheteurs
model Contact {
  id          String  @id @default(uuid()) @db.Uuid
  lastName    String  @map("last_name")
  firstName   String  @map("first_name")
  phoneNumber String  @map("phone_number")
  city        String?
  postalCode  String? @map("postal_code")

  // Relations
  sales  Sale[]
  depots Deposit[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("contacts")
}

// Deposit
model Deposit {
  id                   String             @id @default(uuid()) @db.Uuid
  sellerId             String             @map("seller_id") @db.Uuid
  contributionStatus   ContributionStatus @default(A_PAYER) @map("contribution_status")
  depositIndex         Int                @map("depot_index")
  incrementStart       Int                @map("increment_start")
  dropWorkstationId    Int                @map("deposit_workstation_id")

  collectWorkstationId Int?               @map("collect_workstation_id")
  collectedAt          DateTime?          @map("collected_at")
  paymentAmount        Decimal?           @map("payment_amount") @db.Decimal(6,2)
  chequeNumber         String?            @map("cheque_number")
  signature            String?

  // Relations
  seller   Contact   @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  articles Article[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  user      User?     @relation(fields: [userId], references: [id])
  userId    String?   @db.Uuid

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("deposits")
}

enum ContributionStatus {
  PAYEE
  A_PAYER
  GRATUIT
}

// Sales - Ventes
model Sale {
  id      String @id @default(uuid()) @db.Uuid
  buyerId String @map("buyer_id") @db.Uuid

  // Montants des différents moyens de paiement
  cardAmount  Decimal @default(0) @map("card_amount") @db.Decimal(10, 2)
  cashAmount  Decimal @default(0) @map("cash_amount") @db.Decimal(10, 2)
  checkAmount Decimal @default(0) @map("check_amount") @db.Decimal(10, 2)

  // Montant total de la vente (somme des articles vendus)
  totalAmount Decimal @default(0) @map("total_amount") @db.Decimal(10, 2)
  postalCode  String? @map("postal_code") // Code postal du client

  // Relations
  buyer    Contact   @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  articles Article[]

  saleAt    DateTime  @default(now()) @map("sale_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  user      User?     @relation(fields: [userId], references: [id])
  userId    String?   @db.Uuid

  @@index([updatedAt])
  @@index([deletedAt])
  @@map("sales")
}

// Articles
model Article {
  id String @id @default(uuid()) @db.Uuid

  // Informations article
  price        Decimal? @db.Decimal(10, 2)
  category     String
  discipline   String
  brand        String
  model        String
  size         String
  color        String
  code         String   @unique // Code-barres
  year         Int
  depositIndex Int
  articleIndex String

  // Un article appartient forcément à un dépot
  depositId String? @map("deposit_id") @db.Uuid
  // Un article vendu appartient forcément à une vente
  saleId    String? @map("sale_id") @db.Uuid

  deposit Deposit? @relation(fields: [depositId], references: [id], onDelete: SetNull)
  sale    Sale?    @relation(fields: [saleId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([code])
  @@index([depositId])
  @@index([saleId])
  @@index([updatedAt])
  @@index([deletedAt])
  @@map("articles")
}

// Note: Les triggers PostgreSQL doivent être créés via une migration SQL
// Voir le fichier de migration pour les détails des triggers:
// - notify_stats_changed() : notifie sur le canal 'stats_changed'
// - notify_sales_changed() : notifie sur le canal 'sales_changed'
